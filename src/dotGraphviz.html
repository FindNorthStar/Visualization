<!DOCTYPE html>
<meta charset="utf-8">
<head>
    <link rel="stylesheet" href="css/graph-creator.css"/>
</head>
<body>
<div id="toolbox">
    <input type="file" id="hidden-file-upload">
    <input id="upload-input" type="image" title="upload graph" alt="upload graph">
    <input type="image" id="download-input" title="download graph" alt="download graph">
    <input type="image" id="delete-graph" title="delete graph" alt="delete graph">
</div>

<div id="codebox"></div>

<script src="js/d3.v4.min.js"></script>
<script src="js/viz.js"></script>
<script src="js/d3-graphviz.js"></script>
<div id="graph" style="text-align: center;"></div>
<script>

    var thisGraph = this;

    thisGraph.dots = {};

    thisGraph.state = {};

    var graphviz = d3.select("#graph").graphviz();

    d3.request("data/dots.txt")
        .mimeType("text/plain")
        .get(function (data) {
            var dots = data.response;
            var dotsLines = dots.split('\n');
            var graphLine = 0;
            var graphNameIndex;
            var graphName;

            for (i = 0; i < dotsLines.length; i++) {
                if (dotsLines[i].indexOf("[") === 0 && graphLine === 0) {
                    graphLine++;
                    continue;
                }
                else if (dotsLines[i].indexOf("]") === 0) {
                    graphLine = 0;
                    continue;
                }

                if (graphLine === 1) {
                    //extract graph name or edge name
                    graphNameIndex = dotsLines[i].indexOf("{");
                    graphName = dotsLines[i].slice(0, graphNameIndex).trim();

                    if (graphName !== "digraph") {
                        thisGraph.state[graphName] = {
                            isClicked: false
                        };
                        thisGraph.dots[graphName] = "";
                    }
                    else {
                        thisGraph.dots[graphName] = dotsLines[i] + "\n";
                    }

                    graphLine++;
                    continue;
                }
                else {
                    if (dotsLines[i].indexOf("}") >= 0 && graphName !== "digraph" || dotsLines[i].trim() === "") {
                        continue;
                    }

                    if (dotsLines[i].indexOf("->") >= 0) {
                        var labelRegex = /label="(.*?)"/g;
                        var labelArray = labelRegex.exec(dotsLines[i]);

                        var idRegex = /id="(.*?)"/g;
                        var idArray = idRegex.exec(dotsLines[i]);

                        d3.select("#codebox")
                            .append("p")
                            .text(labelArray[1])
                            .attr("ref", idArray[1]);

                        // console.log(labelArray[1]);
                        // console.log(idArray[1]);
                    }

                    thisGraph.dots[graphName] += dotsLines[i] + "\n";
                }

            }

            function render(dotsrc) {
                var dotSrcLines = dotsrc.split('\n');

                transition1 = d3.transition()
                    .delay(100)
                    .duration(1000);

                graphviz
                    .transition(transition1)
                    .renderDot(dotsrc);

                edges = d3.selectAll('.edge');

                var newDotsArray;

                function displayEdges(edgeId) {
                    // console.log(thisGraph.state.hasOwnProperty(edgeId));

                    if (!thisGraph.state.hasOwnProperty(edgeId)) {
                        console.log(edgeId + " has no isClicked property");
                    }
                    else if (thisGraph.state[edgeId].isClicked === false) {
                        newDotsArray = thisGraph.dots[edgeId].split('\n');

                        for (i = 0; i < newDotsArray.length; i++) {
                            if (newDotsArray[i] !== "") {
                                dotSrcLines.splice(-2, 0, newDotsArray[i]);
                            }
                        }

                        // console.log(dotSrcLines);
                        thisGraph.state[edgeId].isClicked = true;
                        dotsrc = dotSrcLines.join('\n');
                        render(dotsrc);

                    }
                    else {
                        newDotsArray = thisGraph.dots[edgeId].split('\n');

                        for (i = 0; i < newDotsArray.length; i++) {
                            if (newDotsArray[i] !== "") {
                                // console.log(deleteIndex);
                                var deleteIndex = dotSrcLines.indexOf(newDotsArray[i]);
                                dotSrcLines.splice(deleteIndex, 1);
                            }
                        }

                        thisGraph.state[edgeId].isClicked = false;
                        dotsrc = dotSrcLines.join('\n');
                        render(dotsrc);

                    }
                }

                d3.selectAll('p')
                    .on("click", function () {
                        // console.log(d3.select(this).attr("ref"));
                        var edgeId = d3.select(this).attr("ref");
                        displayEdges(edgeId);
                    });

                edges
                    .on("click", function (d) {
                        var edgeId = d.attributes.id;
                        // console.log(edgeId);
                        displayEdges(edgeId);
                    });

            }

            render(thisGraph.dots["digraph"]);

        });

</script>